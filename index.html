
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BECA - Plant Synth</title>
    <style>
      :root {
        color-scheme: light;
        --accent: #1fa86a;
        --bg: #d2e6da;
        --bg-soft: #e2efe7;
        --surface: rgba(255, 255, 255, 0.36);
        --surface-strong: rgba(255, 255, 255, 0.6);
        --edge: rgba(90, 120, 105, 0.25);
        --edge-strong: rgba(90, 120, 105, 0.38);
        --text: #1b2c23;
        --text-muted: rgba(27, 44, 35, 0.6);
        --shadow-base: 0 18px 38px rgba(18, 30, 24, 0.15);
        --shadow-green: 0 12px 28px rgba(31, 168, 106, 0.22);
        --glow: 0 0 22px rgba(31, 168, 106, 0.25);
        --radius: 22px;
        --radius-sm: 16px;
        --gap: 16px;
        --grid: rgba(31, 168, 106, 0.06);
        --key-w: clamp(16px, 3.6vw, 22px);
        --key-h: clamp(50px, 7vw, 66px);
        --key-panel: rgba(240, 246, 242, 0.65);
        --key-white: rgba(252, 254, 253, 0.85);
        --key-black: rgba(24, 34, 29, 0.85);
        --key-border: rgba(90, 120, 105, 0.3);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0 auto;
        padding: clamp(14px, 2vw, 26px);
        min-height: 100vh;
        width: min(1460px, 100%);
        color: var(--text);
        background:
          radial-gradient(900px 520px at 78% -10%, rgba(31, 168, 106, 0.22), transparent 62%),
          radial-gradient(760px 540px at 12% 18%, rgba(136, 200, 170, 0.25), transparent 62%),
          radial-gradient(520px 420px at 88% 84%, rgba(31, 168, 106, 0.18), transparent 60%),
          linear-gradient(160deg, var(--bg) 0%, var(--bg-soft) 58%, var(--bg) 100%);
        font-family:
          "SF Pro Display",
          "SF Pro Text",
          "Avenir Next",
          "Helvetica Neue",
          "Segoe UI",
          sans-serif;
        letter-spacing: 0.01em;
      }
      body::before {
        content: "";
        position: fixed;
        inset: -20% -20% -10% -20%;
        background:
          radial-gradient(40% 35% at 70% 18%, rgba(31, 168, 106, 0.14), transparent 60%),
          radial-gradient(36% 30% at 18% 80%, rgba(31, 168, 106, 0.12), transparent 65%);
        z-index: -2;
      }
      body::after {
        content: "";
        position: fixed;
        inset: 0;
        background-image:
          linear-gradient(var(--grid) 1px, transparent 1px),
          linear-gradient(90deg, var(--grid) 1px, transparent 1px);
        background-size: 28px 28px;
        opacity: 0.3;
        pointer-events: none;
        z-index: -1;
      }
      a {
        color: inherit;
        text-decoration: none;
      }
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding: 4px 6px 18px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .brand img {
        height: 34px;
        filter: drop-shadow(0 0 12px rgba(31, 168, 106, 0.28));
      }
      .brand .title {
        font-size: 15px;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--text);
        font-weight: 700;
      }
      .brand .sub {
        font-size: 12px;
        opacity: 0.7;
      }
      .top-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .pill {
        padding: 7px 14px;
        border: 1px solid var(--edge);
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.7);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        box-shadow: 0 8px 16px rgba(31, 168, 106, 0.12);
      }
      .status-pill::before {
        content: "";
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--accent);
        margin-right: 8px;
        box-shadow: 0 0 10px rgba(31, 168, 106, 0.35);
        vertical-align: middle;
      }
      .mono {
        font-family: "SF Mono", "JetBrains Mono", Consolas, monospace;
        letter-spacing: 0.01em;
      }
      .main-grid {
        display: grid;
        grid-template-columns: minmax(360px, 1.35fr) minmax(320px, 1fr);
        grid-template-areas:
          "io io"
          "music led";
        gap: var(--gap);
        align-items: stretch;
      }
      .panel {
        background: var(--surface);
        border: 1px solid var(--edge-strong);
        border-radius: var(--radius);
        padding: 16px;
        box-shadow: var(--shadow-base), var(--shadow-green);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(26px) saturate(180%);
      }
      .panel::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.65), rgba(255, 255, 255, 0.18) 45%, rgba(255, 255, 255, 0) 70%);
        pointer-events: none;
      }
      .panel::after {
        content: "";
        position: absolute;
        inset: 7px;
        border-radius: calc(var(--radius) - 7px);
        border: 1px solid rgba(255, 255, 255, 0.35);
        pointer-events: none;
      }
      .panel-io {
        grid-area: io;
      }
      .panel-theory {
        grid-area: music;
      }
      .panel-led {
        grid-area: led;
      }
      .panel-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--edge);
      }
      .panel-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: var(--text);
        font-weight: 700;
      }
      .panel-tag {
        display: none;
      }
      .subcard {
        background: var(--surface-strong);
        border: 1px solid var(--edge);
        border-radius: var(--radius-sm);
        padding: 12px;
        box-shadow: 0 10px 18px rgba(31, 168, 106, 0.12), inset 0 0 0 1px rgba(255, 255, 255, 0.45);
      }
      .module,
      .module-azure,
      .module-lilac,
      .module-olive,
      .module-butter,
      .module-salmon,
      .module-rose,
      .module-cyan,
      .module-mint {
        background: var(--surface-strong);
        border-color: var(--edge);
        color: var(--text);
        box-shadow: 0 10px 18px rgba(31, 168, 106, 0.12), inset 0 0 0 1px rgba(255, 255, 255, 0.45);
      }
      .stack {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .info-stack {
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 12px;
      }
      .info-stack .subcard:last-child {
        min-height: 260px;
      }
      .io-grid {
        display: grid;
        grid-template-columns: minmax(320px, 1.25fr) minmax(260px, 0.85fr);
        gap: 12px;
        align-items: stretch;
      }
      .theory-grid,
      .led-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .label {
        font-size: 12px;
        letter-spacing: 0.06em;
        opacity: 0.82;
        font-weight: 600;
      }
      .hdr {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }
      .val {
        font-variant-numeric: tabular-nums;
        font-family: "SF Mono", "JetBrains Mono", Consolas, monospace;
      }
      .ctrl {
        margin-top: 12px;
      }
      .btn,
      select,
      input[type="range"],
      input[type="checkbox"] {
        background: rgba(255, 255, 255, 0.6);
        color: var(--text);
        border: 1px solid var(--edge-strong);
        border-radius: 12px;
        padding: 10px 12px;
        font-family: inherit;
        font-size: 13px;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.45);
      }
      select {
        width: 100%;
        appearance: none;
        background-image:
          linear-gradient(45deg, transparent 50%, var(--text) 50%),
          linear-gradient(135deg, var(--text) 50%, transparent 50%);
        background-position: calc(100% - 18px) 50%, calc(100% - 12px) 50%;
        background-size: 6px 6px, 6px 6px;
        background-repeat: no-repeat;
      }
      input[type="range"] {
        width: 100%;
        height: 34px;
        -webkit-appearance: none;
        appearance: none;
        padding: 0;
        background: transparent;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        height: 6px;
        background: linear-gradient(90deg, rgba(31, 168, 106, 0.3), rgba(31, 168, 106, 0.18));
        border-radius: 999px;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        margin-top: -6px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--accent);
        border: 1px solid rgba(255, 255, 255, 0.75);
        box-shadow: 0 0 10px rgba(31, 168, 106, 0.35);
      }
      input[type="checkbox"] {
        width: 18px;
        height: 18px;
        padding: 0;
      }
      .btn {
        cursor: pointer;
        transition: all 0.18s ease;
        text-align: center;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(31, 168, 106, 0.16);
      }
      .btn.ghost {
        padding: 8px 14px;
        border-radius: 999px;
      }
      .btn.accent {
        border-color: var(--accent-strong);
      }
      .icon-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
      }
      .icon svg {
        width: 100%;
        height: 100%;
      }
      .kv {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 6px 12px;
        font-size: 12px;
      }
      .kv .label {
        font-size: 10px;
        opacity: 0.6;
        letter-spacing: 0.08em;
      }
      .kbd {
        display: flex;
        gap: 2px;
        margin-top: 8px;
        padding: 10px;
        border-radius: 14px;
        border: 1px solid var(--edge-strong);
        background: var(--key-panel);
        justify-content: center;
        min-height: calc(var(--key-h) + 16px);
      }
      .key {
        width: var(--key-w);
        height: var(--key-h);
        border: 1px solid var(--key-border);
        background: var(--key-white);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.5);
      }
      .key.white {
        background: var(--key-white);
      }
      .key.black {
        background: var(--key-black);
        height: calc(var(--key-h) * 0.62);
        margin-left: calc(var(--key-w) * -0.48);
        margin-right: calc(var(--key-w) * -0.48);
        z-index: 2;
        width: calc(var(--key-w) * 0.88);
        border-color: var(--key-border);
      }
      .key.sel {
        outline: 2px solid var(--accent);
        box-shadow: 0 0 12px rgba(31, 168, 106, 0.35);
      }
      #osc,
      #notegrid {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--edge-strong);
        background: radial-gradient(150% 120% at 50% 50%, rgba(241, 247, 243, 0.95) 0%, rgba(230, 238, 233, 0.9) 60%, rgba(222, 231, 225, 0.92) 100%);
      }
      #osc {
        height: 160px;
      }
      #notegrid {
        height: 130px;
        margin-top: 8px;
      }
      .small {
        font-size: 11px;
        opacity: 0.75;
      }
      /* ---- Drum UI ---- */
      #drumWrap {
        margin-top: 12px;
      }
      #drumWrap.hidden {
        display: none;
      }
      .drumTitle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
      }
      .drumGrid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 10px;
        margin-top: 10px;
        align-items: center;
      }
      .dSel {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .dSel input {
        width: 18px;
        height: 18px;
        accent-color: var(--accent);
      }
      .dBox {
        height: 56px;
        border-radius: 14px;
        border: 2px solid rgba(31, 168, 106, 0.38);
        background: rgba(255, 255, 255, 0.45);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4), 0 6px 12px rgba(31, 168, 106, 0.12);
        transition: all 0.08s;
      }
      .dBox.hit {
        border-color: rgba(31, 168, 106, 0.75);
        box-shadow: 0 0 16px rgba(31, 168, 106, 0.25), inset 0 0 0 1px rgba(31, 168, 106, 0.35);
        background: rgba(31, 168, 106, 0.16);
      }
      .dLab {
        text-align: center;
        font-size: 11px;
        opacity: 0.75;
        margin-top: -4px;
        font-family: "SF Mono", "JetBrains Mono", Consolas, monospace;
        white-space: pre-line;
      }
      .utility-bar {
        margin-top: 16px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        align-items: center;
      }
      .toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border: 1px solid var(--edge-strong);
        border-radius: 16px;
        background: var(--surface-strong);
        min-width: 180px;
        box-shadow: 0 8px 16px rgba(31, 168, 106, 0.12);
      }
      .toggle input {
        display: none;
      }
      .switch {
        width: 44px;
        height: 24px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(31, 168, 106, 0.45);
        position: relative;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }
      .switch::after {
        content: "";
        position: absolute;
        width: 18px;
        height: 18px;
        left: 2px;
        top: 2px;
        border-radius: 50%;
        background: #f7faf8;
        transition: all 0.2s ease;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.08);
      }
      .toggle input:checked + .switch {
        background: rgba(31, 168, 106, 0.22);
        border-color: rgba(31, 168, 106, 0.6);
      }
      .toggle input:checked + .switch::after {
        left: 24px;
        background: var(--accent);
      }
      .toggle-label {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        opacity: 0.85;
      }
      .toggle-val {
        margin-left: auto;
        font-size: 11px;
        opacity: 0.8;
      }
      .utility-bar .btn,
      .utility-bar .toggle {
        width: 100%;
      }
      body.ui-muted main {
        opacity: 0.55;
        filter: grayscale(0.2);
        pointer-events: none;
      }
      body.ui-muted .utility-bar {
        pointer-events: auto;
      }
      body.ui-muted .utility-bar .toggle:not(.mute-toggle),
      body.ui-muted #rnd {
        opacity: 0.4;
        pointer-events: none;
      }
      body.ui-muted #status {
        border-color: rgba(31, 168, 106, 0.4);
        color: #8b5a35;
      }
      @media (max-width: 1200px) {
        .main-grid {
          grid-template-columns: 1fr;
          grid-template-areas:
            "io"
            "music"
            "led";
        }
      }
      @media (max-width: 900px) {
        .io-grid {
          grid-template-columns: 1fr;
        }
        .topbar {
          flex-direction: column;
          align-items: flex-start;
        }
        .top-actions {
          width: 100%;
          justify-content: space-between;
        }
      }
      @media (max-width: 640px) {
        .brand .title {
          font-size: 14px;
          letter-spacing: 0.14em;
        }
        .panel {
          padding: 14px;
        }
        .grid2 {
          grid-template-columns: 1fr;
        }
        .kbd {
          justify-content: flex-start;
          overflow-x: auto;
        }
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <img src="/logo" alt="BECA" />
        <div>
          <div class="title">BECA Plant Synth</div>
          <div class="sub">Fatty Recording Co.</div>
        </div>
      </div>
      <div class="top-actions">
        <a class="btn ghost icon-btn" href="/setup" aria-label="Settings">
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3.2" />
              <path d="M19.4 15a1.6 1.6 0 0 0 .32 1.76l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.6 1.6 0 0 0-1.76-.32 1.6 1.6 0 0 0-1 1.46V22a2 2 0 0 1-4 0v-.1a1.6 1.6 0 0 0-1-1.46 1.6 1.6 0 0 0-1.76.32l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.6 1.6 0 0 0 4.6 15a1.6 1.6 0 0 0-1.46-1H3a2 2 0 0 1 0-4h.1a1.6 1.6 0 0 0 1.46-1 1.6 1.6 0 0 0-.32-1.76l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.6 1.6 0 0 0 8.4 4.6a1.6 1.6 0 0 0 1-1.46V3a2 2 0 0 1 4 0v.1a1.6 1.6 0 0 0 1 1.46 1.6 1.6 0 0 0 1.76-.32l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.6 1.6 0 0 0 19.4 9a1.6 1.6 0 0 0 1.46 1H21a2 2 0 0 1 0 4h-.1a1.6 1.6 0 0 0-1.46 1Z" />
            </svg>
          </span>
          <span>Settings</span>
        </a>
        <div id="status" class="pill mono status-pill">connecting...</div>
      </div>
    </header>

    <main class="main-grid">
      <section class="panel panel-io">
        <div class="panel-head">
          <div class="panel-title">Input / Output</div>
          
        </div>
        <div class="io-grid">
          <div class="stack info-stack">
            <div class="subcard module module-azure">
              <div class="hdr">
                <div class="label">Plant</div>
              </div>
              <canvas id="osc" width="900" height="160"></canvas>
            </div>

            <div class="subcard module module-lilac">
              <div class="hdr">
                <div class="label">Note Grid</div>
                <div class="small mono" id="gridLab">--</div>
              </div>
              <canvas id="notegrid" width="900" height="130"></canvas>

              <div id="drumWrap" class="hidden">
                <div class="drumTitle">
                  <div class="label">Drum Kit</div>
                  <div class="small mono" id="drumLab">--</div>
                </div>
                <div class="drumGrid" id="drumSelRow"></div>
                <div class="drumGrid" id="drumHitRow" style="margin-top: 8px"></div>
                <div class="drumGrid" id="drumNameRow" style="margin-top: 6px"></div>
              </div>
            </div>
          </div>

          <div class="stack">
            <div class="subcard module module-butter">
              <div class="ctrl" style="margin-top: 0">
                <div class="hdr">
                  <div class="label">Sensitivity</div>
                  <div class="val mono" id="sensVal">--</div>
                </div>
                <input
                  id="sensRange"
                  type="range"
                  min="0.00"
                  max="0.50"
                  step="0.05"
                />
              </div>
            </div>

            <div class="subcard module module-olive">
              <div class="hdr" style="margin-bottom: 8px">
                <div class="label">Info Snapshot</div>
              </div>
              <div class="kv mono">
                <div class="label">BLE:</div>
                <div id="ble">--</div>
                <div class="label">Clock:</div>
                <div id="clock">--</div>
                <div class="label">Mode:</div>
                <div id="modeLab">--</div>
                <div class="label">Scale:</div>
                <div id="scaleLab">--</div>
                <div class="label">Root:</div>
                <div id="rootLab">--</div>
                <div class="label">BPM:</div>
                <div id="bpmLab">--</div>
                <div class="label">Swing:</div>
                <div id="swingLab">--</div>
                <div class="label">Brightness:</div>
                <div id="brightLab">--</div>
                <div class="label">Sensitivity:</div>
                <div id="sensLab">--</div>
                <div class="label">Effect:</div>
                <div id="fxLab">--</div>
                <div class="label">Palette:</div>
                <div id="palLab">--</div>
                <div class="label">Oct Range:</div>
                <div id="octLab">--</div>
                <div class="label">Time Sig:</div>
                <div id="tsLab">--</div>
                <div class="label">Last:</div>
                <div id="lastLab">--</div>
                <div class="label">Velocity:</div>
                <div id="velLab">--</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="panel panel-theory">
        <div class="panel-head">
          <div class="panel-title">Music</div>
          
        </div>
        <div class="theory-grid">
          <div class="subcard module module-salmon">
            <div class="grid2">
              <div>
                <div class="label">Mode</div>
                <select id="mode">
                  <option value="0">Notes</option>
                  <option value="1">Arpeggiator</option>
                  <option value="2">Chords</option>
                  <option value="3">Drum Machine</option>
                </select>
              </div>
              <div>
                <div class="label">Clock</div>
                <select id="clockSel">
                  <option value="1">Plant</option>
                  <option value="0">Internal</option>
                </select>
              </div>
            </div>

            <div class="label" style="margin-top: 12px">Scale</div>
            <select id="scale">
              <option value="0">Major</option>
              <option value="1">Minor</option>
              <option value="2">Dorian</option>
              <option value="3">Lydian</option>
              <option value="4">Mixolydian</option>
              <option value="5">Pent Minor</option>
              <option value="6">Pent Major</option>
              <option value="7">Harm Minor</option>
              <option value="8">Phrygian</option>
              <option value="9">Whole Tone</option>
              <option value="10">Maj7</option>
              <option value="11">Min7</option>
              <option value="12">Dom7</option>
              <option value="13">Sus2</option>
              <option value="14">Sus4</option>
            </select>

            <div class="label" style="margin-top: 12px">Root (piano)</div>
            <div id="piano" class="kbd"></div>
          </div>

          <div class="subcard module module-rose">
            <div class="ctrl" style="margin-top: 0">
              <div class="hdr">
                <div class="label">Tempo</div>
                <div class="val mono" id="bpmVal">--</div>
              </div>
              <input id="bpmRange" type="range" min="20" max="240" step="5" />
            </div>
            <div class="ctrl">
              <div class="hdr">
                <div class="label">Swing</div>
                <div class="val mono" id="swingVal">--</div>
              </div>
              <input id="swingRange" type="range" min="0" max="60" step="1" />
            </div>
            <div class="ctrl">
              <div class="hdr">
                <div class="label">Rest</div>
                <div class="val mono" id="restVal">--</div>
              </div>
              <input id="rest" type="range" min="0" max="80" step="1" />
            </div>
            <div class="grid2">
              <div class="ctrl">
                <div class="hdr">
                  <div class="label">Low Oct</div>
                  <div class="val mono" id="loVal">--</div>
                </div>
                <input id="loct" type="range" min="0" max="9" step="1" />
              </div>
              <div class="ctrl">
                <div class="hdr">
                  <div class="label">High Oct</div>
                  <div class="val mono" id="hiVal">--</div>
                </div>
                <input id="hoct" type="range" min="0" max="9" step="1" />
              </div>
            </div>
            <div class="ctrl">
              <div class="hdr">
                <div class="label">Time Signature</div>
                <div class="val mono" id="tsVal">--</div>
              </div>
              <select id="tsSel">
                <option value="1-1">1/1</option>
                <option value="2-2">2/2</option>
                <option value="2-4">2/4</option>
                <option value="3-4">3/4</option>
                <option value="4-4" selected>4/4</option>
                <option value="5-4">5/4</option>
                <option value="7-4">7/4</option>
                <option value="6-8">6/8</option>
                <option value="9-8">9/8</option>
                <option value="12-8">12/8</option>
                <option value="4-8">4/8</option>
                <option value="4-16">4/16</option>
                <option value="8-32">8/32</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <section class="panel panel-led">
        <div class="panel-head">
          <div class="panel-title">LED</div>
          
        </div>
        <div class="led-grid">
          <div class="subcard module module-cyan">
            <div class="ctrl" style="margin-top: 0">
              <div class="hdr">
                <div class="label">Effect</div>
                <div class="val mono" id="fxVal">--</div>
              </div>
              <select id="effect"></select>
            </div>
            <div class="ctrl">
              <div class="hdr">
                <div class="label">Palette</div>
                <div class="val mono" id="palVal">--</div>
              </div>
              <select id="palette"></select>
            </div>
          </div>

          <div class="subcard module module-mint">
            <div class="ctrl" style="margin-top: 0">
              <div class="hdr">
                <div class="label">Brightness</div>
                <div class="val mono" id="brightVal">--</div>
              </div>
              <input id="brightRange" type="range" min="10" max="255" step="1" />
            </div>
            <div class="ctrl">
              <div class="hdr">
                <div class="label">Visual Speed</div>
                <div class="val mono" id="vsVal">--</div>
              </div>
              <input id="visSpd" type="range" min="0" max="255" step="1" />
            </div>
            <div class="ctrl">
              <div class="hdr">
                <div class="label">Visual Intensity</div>
                <div class="val mono" id="viVal">--</div>
              </div>
              <input id="visInt" type="range" min="0" max="255" step="1" />
            </div>
          </div>
        </div>
      </section>
    </main>

    <div class="utility-bar">
      <label class="toggle module module-olive">
        <input id="norep" type="checkbox" />
        <span class="switch"></span>
        <span class="toggle-label">
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12a9 9 0 0 1 15.2-6.2" />
              <path d="M18 3v5h-5" />
              <path d="M21 12a9 9 0 0 1-15.2 6.2" />
              <path d="M6 21v-5h5" />
            </svg>
          </span>
          Avoid repeat
        </span>
        <span class="toggle-val mono" id="nrVal">--</span>
      </label>

      <button id="rnd" class="btn accent icon-btn module module-butter">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3.5" y="3.5" width="17" height="17" rx="3" />
            <circle cx="8.5" cy="8.5" r="1.2" />
            <circle cx="15.5" cy="15.5" r="1.2" />
            <circle cx="15.5" cy="8.5" r="1.2" />
            <circle cx="8.5" cy="15.5" r="1.2" />
            <circle cx="12" cy="12" r="1.2" />
          </svg>
        </span>
        Randomize
      </button>

      <label class="toggle mute-toggle module module-rose">
        <input id="mute" type="checkbox" />
        <span class="switch"></span>
        <span class="toggle-label">
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 3v9" />
              <path d="M7.5 5.5a7 7 0 1 0 9 0" />
            </svg>
          </span>
          Mute I/O
        </span>
        <span class="toggle-val mono" id="muteVal">OFF</span>
      </label>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      const status = $("status");
      const ble = $("ble");
      const clock = $("clock");
      const modeLab = $("modeLab");
      const scaleLab = $("scaleLab");
      const rootLab = $("rootLab");
      const bpmLab = $("bpmLab");
      const swingLab = $("swingLab");
      const brightLab = $("brightLab");
      const sensLab = $("sensLab");
      const fxLab = $("fxLab");
      const palLab = $("palLab");
      const octLab = $("octLab");
      const tsLab = $("tsLab");
      const lastLab = $("lastLab");
      const velLab = $("velLab");

      const mode = $("mode");
      const clockSel = $("clockSel");
      const scale = $("scale");
      const tsSel = $("tsSel");

      const bpmRange = $("bpmRange");
      const swingRange = $("swingRange");
      const brightRange = $("brightRange");
      const sensRange = $("sensRange");
      const loct = $("loct");
      const hoct = $("hoct");

      const effect = $("effect");
      const palette = $("palette");

      const visSpd = $("visSpd");
      const visInt = $("visInt");
      const rest = $("rest");
      const norep = $("norep");
      const rnd = $("rnd");
      const mute = $("mute");
      const muteVal = $("muteVal");

      const bpmVal = $("bpmVal");
      const swingVal = $("swingVal");
      const brightVal = $("brightVal");
      const sensVal = $("sensVal");
      const loVal = $("loVal");
      const hiVal = $("hiVal");
      const fxVal = $("fxVal");
      const palVal = $("palVal");
      const vsVal = $("vsVal");
      const viVal = $("viVal");
      const restVal = $("restVal");
      const nrVal = $("nrVal");
      const tsVal = $("tsVal");

      const osc = $("osc");
      const ctx = osc.getContext("2d");
      const N = 220;

      let plantA = new Array(N).fill(0);
      let uiMuted = false;


      function grid() {
        const w = osc.width,
          h = osc.height;
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = "#041107";
        ctx.fillRect(0, 0, w, h);
        ctx.strokeStyle = "#0e2116";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 8; i++) {
          const y = i * (h / 8);
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(w, y);
          ctx.stroke();
        }
        for (let j = 0; j <= 12; j++) {
          const x = j * (w / 12);
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, h);
          ctx.stroke();
        }
      }
      function line(arr, col, maxv) {
        const w = osc.width,
          h = osc.height;
        ctx.strokeStyle = col;
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i < arr.length; i++) {
          const X = i * (w / (N - 1));
          const Y = h - Math.min(arr[i] / maxv, 1) * h;
          if (!i) ctx.moveTo(X, Y);
          else ctx.lineTo(X, Y);
        }
        ctx.stroke();
      }
      function setVal(el, v) {
        if (el) el.textContent = v;
      }

      const debouncers = {};
      function sendNow(url) {
        if (uiMuted) return;
        fetch(url, { cache: "no-store" }).catch(() => {});
      }
      function debouncedSend(key, url, delay = 90) {
        if (uiMuted) return;
        if (debouncers[key]) clearTimeout(debouncers[key]);
        debouncers[key] = setTimeout(() => sendNow(url), delay);
      }

      const MODE_NAMES = ["Notes", "Arpeggiator", "Chords", "Drum Machine"];
      const SCALE_NAMES = [
        "Major",
        "Minor",
        "Dorian",
        "Lydian",
        "Mixolydian",
        "Pent Minor",
        "Pent Major",
        "Harm Minor",
        "Phrygian",
        "Whole Tone",
        "Maj7",
        "Min7",
        "Dom7",
        "Sus2",
        "Sus4",
      ];
      const NOTE_NAMES = [
        "C",
        "C#",
        "D",
        "D#",
        "E",
        "F",
        "F#",
        "G",
        "G#",
        "A",
        "A#",
        "B",
      ];

      function updatePianoSel(semi) {
        const piano = $("piano");
        [...piano.children].forEach((k, i) =>
          k.classList.toggle("sel", i === semi),
        );
      }

      // ---- MIDI NOTE GRID ----
      const gridLab = $("gridLab");
      const noteGrid = $("notegrid");
      const ng = noteGrid.getContext("2d");

      const GRID_COLS = 12;
      const GRID_ROWS = 8;

      function noteName(m) {
        const semi = ((m % 12) + 12) % 12;
        const oct = Math.floor(m / 12) - 1;
        return NOTE_NAMES[semi] + oct;
      }

      function drawNoteGridMulti(midiList, vel, held) {
        const w = noteGrid.width,
          h = noteGrid.height;
        ng.clearRect(0, 0, w, h);

        ng.fillStyle = "#041107";
        ng.fillRect(0, 0, w, h);

        const pad = 10;
        const gx = pad,
          gy = pad;
        const gw = w - pad * 2,
          gh = h - pad * 2;

        const cellW = gw / GRID_COLS;
        const cellH = gh / GRID_ROWS;

        ng.strokeStyle = "#0e2116";
        ng.lineWidth = 1;
        for (let r = 0; r <= GRID_ROWS; r++) {
          const y = gy + r * cellH;
          ng.beginPath();
          ng.moveTo(gx, y);
          ng.lineTo(gx + gw, y);
          ng.stroke();
        }
        for (let c = 0; c <= GRID_COLS; c++) {
          const x = gx + c * cellW;
          ng.beginPath();
          ng.moveTo(x, gy);
          ng.lineTo(x, gy + gh);
          ng.stroke();
        }

        ng.fillStyle = "rgba(233,255,238,.7)";
        ng.font = "12px JetBrains Mono, Consolas, monospace";
        for (let c = 0; c < 12; c++) {
          ng.fillText(NOTE_NAMES[c], gx + c * cellW + 6, gy - 2);
        }

        const a = held ? 1.0 : 0.6;
        const v = Math.max(0, Math.min(127, vel | 0)) / 127;

        midiList.forEach((midi) => {
          let m = Math.max(12, Math.min(119, midi | 0));
          let idx = m - 12;
          let semi = idx % 12;
          let oct = Math.floor(idx / 12);
          if (oct > 7) oct = 7;

          const x = gx + semi * cellW;
          const y = gy + (GRID_ROWS - 1 - oct) * cellH;

          ng.fillStyle = `rgba(0,255,122,${0.14 * a + 0.45 * a * v})`;
          ng.fillRect(x + 1, y + 1, cellW - 2, cellH - 2);

          ng.strokeStyle = `rgba(0,255,122,${0.6 * a})`;
          ng.lineWidth = 2;
          ng.strokeRect(x + 2, y + 2, cellW - 4, cellH - 4);
        });

        if (!midiList.length) {
          gridLab.textContent = "--";
        } else {
          const names = midiList.slice(0, 6).map(noteName).join(" ");
          gridLab.textContent = `${held ? "HOLD" : "hit"} | ${names}${midiList.length > 6 ? " ..." : ""} | vel ${vel | 0}`;
        }
      }
      // ---- DRUM UI ----
      const drumWrap = $("drumWrap");
      const drumLab = $("drumLab");
      const drumSelRow = $("drumSelRow");
      const drumHitRow = $("drumHitRow");
      const drumNameRow = $("drumNameRow");

      const DRUM_NAMES = [
        "kick",
        "snare",
        "closed\nhihat",
        "open\nhihat",
        "tom1",
        "tom2",
        "ride",
        "crash",
      ];
      let drumSelMask = 0xff;

      const drumSelChecks = [];
      const drumHitBoxes = [];

      function buildDrumUI() {
        drumSelRow.innerHTML = "";
        drumHitRow.innerHTML = "";
        drumNameRow.innerHTML = "";

        for (let i = 0; i < 8; i++) {
          const s = document.createElement("div");
          s.className = "dSel";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = true;
          cb.onchange = () => {
            drumSelMask = 0;
            for (let k = 0; k < 8; k++) {
              if (drumSelChecks[k].checked) drumSelMask |= 1 << k;
            }
            debouncedSend("drumsel", "/drumsel?mask=" + drumSelMask, 30);
            drumLab.textContent = "enabled: " + drumSelMask;
          };
          s.appendChild(cb);
          drumSelRow.appendChild(s);
          drumSelChecks.push(cb);

          const b = document.createElement("div");
          b.className = "dBox";
          drumHitRow.appendChild(b);
          drumHitBoxes.push(b);

          const l = document.createElement("div");
          l.className = "dLab";
          l.textContent = DRUM_NAMES[i];
          drumNameRow.appendChild(l);
        }
      }

      function applyDrumSelMask(mask) {
        drumSelMask = mask & 255;
        for (let i = 0; i < 8; i++) {
          drumSelChecks[i].checked = !!(drumSelMask & (1 << i));
        }
        drumLab.textContent = "enabled: " + drumSelMask;
      }

      function applyDrumHitMask(hitMask) {
        for (let i = 0; i < 8; i++) {
          drumHitBoxes[i].classList.toggle("hit", !!(hitMask & (1 << i)));
        }
      }

      function setUiMuted(on) {
        uiMuted = !!on;
        document.body.classList.toggle("ui-muted", uiMuted);
        setVal(muteVal, uiMuted ? "ON" : "OFF");
        if (uiMuted) status.textContent = "muted";
      }

      // ---- Boot UI ----
      (async () => {
        try {
          const E = await (
            await fetch("/effects", { cache: "force-cache" })
          ).json();
          const P = await (
            await fetch("/palettes", { cache: "force-cache" })
          ).json();

          (E.list || []).forEach((name, idx) => {
            const o = document.createElement("option");
            o.value = idx;
            o.textContent = name;
            effect.appendChild(o);
          });
          (P.list || []).forEach((name, idx) => {
            const o = document.createElement("option");
            o.value = idx;
            o.textContent = name;
            palette.appendChild(o);
          });

          const piano = $("piano");
          for (let i = 0; i < 12; i++) {
            const isBlack = NOTE_NAMES[i].includes("#");
            const div = document.createElement("div");
            div.className = "key " + (isBlack ? "black" : "white");
            div.title = NOTE_NAMES[i];
            div.onclick = () => {
              sendNow("/root?semi=" + i);
              updatePianoSel(i);
            };
            piano.appendChild(div);
          }

          buildDrumUI();

          grid();
          drawNoteGridMulti([], 96, false);
        } catch (e) {
          status.textContent = "ui error";
        }
      })();

      // SSE stream
      const es = new EventSource("/events");

      es.addEventListener("hello", () => {
        if (!uiMuted) status.textContent = "ok";
      });

      es.onerror = () => {
        if (!uiMuted) status.textContent = "reconnecting...";
      };

      es.addEventListener("state", (e) => {
        const j = JSON.parse(e.data);
        if (!uiMuted) status.textContent = "ok";

        ble.textContent = j.ble ? "connected" : "--";
        clock.textContent = j.clock ? "Plant" : "Internal";
        modeLab.textContent = MODE_NAMES[j.mode] || "--";
        scaleLab.textContent = SCALE_NAMES[j.scale] || "--";
        rootLab.textContent = NOTE_NAMES[j.root] || "--";
        bpmLab.textContent = j.bpm;
        swingLab.textContent = j.swing + "%";
        brightLab.textContent = j.bright;
        sensLab.textContent = (+j.sens).toFixed(2);
        fxLab.textContent = j.fxname || "--";
        palLab.textContent = j.palname || "--";
        octLab.textContent = "C" + j.lo + " .. C" + j.hi;
        tsLab.textContent = j.ts;
        velLab.textContent = j.vel;
        if (lastLab) lastLab.textContent = j.last || "--";

        bpmRange.value = j.bpm;
        swingRange.value = j.swing;
        brightRange.value = j.bright;
        sensRange.value = j.sens;
        loct.value = j.lo;
        hoct.value = j.hi;

        mode.value = j.mode;
        clockSel.value = j.clock;
        scale.value = j.scale;
        tsSel.value = j.ts.replace("/", "-");

        effect.value = j.fx;
        palette.value = j.pal;

        visSpd.value = j.vs;
        visInt.value = j.vi;

        rest.value = Math.round(j.rest * 100);
        norep.checked = !!j.nr;

        setVal(bpmVal, j.bpm);
        setVal(swingVal, j.swing + "%");
        setVal(brightVal, j.bright);
        setVal(sensVal, (+j.sens).toFixed(2));
        setVal(loVal, "C" + j.lo);
        setVal(hiVal, "C" + j.hi);
        setVal(fxVal, fxLab.textContent);
        setVal(palVal, palLab.textContent);
        setVal(vsVal, j.vs);
        setVal(viVal, j.vi);
        setVal(restVal, Math.round(j.rest * 100) + "%");
        setVal(nrVal, j.nr ? "ON" : "OFF");
        setVal(tsVal, j.ts);

        updatePianoSel(j.root | 0);

        const isDrum = (j.mode | 0) === 3;
        drumWrap.classList.toggle("hidden", !isDrum);

        if (typeof j.drumsel !== "undefined") applyDrumSelMask(j.drumsel | 0);

        const lastMidi = parseInt(j.last, 10);
        if (!Number.isNaN(lastMidi))
          drawNoteGridMulti([lastMidi], j.vel | 0, false);
      });
      es.addEventListener("scope", (e) => {
        const plant = Number(e.data);
        plantA.push(plant);
        plantA.shift();
        grid();
        line(plantA, "#00ff7a", 1.0);
      });

      es.addEventListener("note", (e) => {
        const [heldS, velS, nS, listS] = e.data.split("|");
        const held = Number(heldS) === 1;
        const vel = Number(velS) || 96;
        const list =
          listS && listS.length
            ? listS
                .split(",")
                .map((x) => Number(x))
                .filter((x) => !Number.isNaN(x))
            : [];
        drawNoteGridMulti(list, vel, held);
      });

      es.addEventListener("drum", (e) => {
        const [hitS, selS] = e.data.split("|");
        const hit = (Number(hitS) || 0) & 255;
        const sel = (Number(selS) || 0) & 255;
        applyDrumSelMask(sel);
        applyDrumHitMask(hit);
      });

      bpmRange.oninput = (e) => {
        const v = e.target.value;
        setVal(bpmVal, v);
        debouncedSend("bpm", "/bpm?v=" + v, 60);
      };
      swingRange.oninput = (e) => {
        const v = e.target.value;
        setVal(swingVal, v + "%");
        debouncedSend("swing", "/swing?v=" + v, 60);
      };
      brightRange.oninput = (e) => {
        const v = e.target.value;
        setVal(brightVal, v);
        debouncedSend("bright", "/b?v=" + v, 60);
      };
      sensRange.oninput = (e) => {
        const v = e.target.value;
        setVal(sensVal, (+v).toFixed(2));
        debouncedSend("sens", "/s?v=" + v, 60);
      };
      loct.oninput = (e) => {
        const v = e.target.value;
        setVal(loVal, "C" + v);
        debouncedSend("lo", "/lo?v=" + v, 60);
      };
      hoct.oninput = (e) => {
        const v = e.target.value;
        setVal(hiVal, "C" + v);
        debouncedSend("hi", "/hi?v=" + v, 60);
      };

      mode.onchange = (e) =>
        debouncedSend("mode", "/mode?i=" + e.target.value, 30);
      clockSel.onchange = (e) =>
        debouncedSend("clock", "/clock?v=" + e.target.value, 30);
      scale.onchange = (e) =>
        debouncedSend("scale", "/scale?i=" + e.target.value, 30);

      effect.onchange = (e) => {
        const idx = e.target.value;
        const name = e.target.options[e.target.selectedIndex].text;
        setVal(fxVal, name);
        debouncedSend("fx", "/fxset?i=" + idx, 30);
      };
      palette.onchange = (e) => {
        const idx = e.target.value;
        const name = e.target.options[e.target.selectedIndex].text;
        setVal(palVal, name);
        debouncedSend("pal", "/pal?i=" + idx, 30);
      };

      visSpd.oninput = (e) => {
        const v = e.target.value;
        setVal(vsVal, v);
        debouncedSend("vs", "/visspd?v=" + v, 60);
      };
      visInt.oninput = (e) => {
        const v = e.target.value;
        setVal(viVal, v);
        debouncedSend("vi", "/visint?v=" + v, 60);
      };
      rest.oninput = (e) => {
        const v = e.target.value;
        setVal(restVal, v + "%");
        debouncedSend("rest", "/rest?v=" + v / 100, 60);
      };
      norep.onchange = (e) => {
        const v = e.target.checked ? 1 : 0;
        setVal(nrVal, v ? "ON" : "OFF");
        debouncedSend("nr", "/norep?v=" + v, 30);
      };

      tsSel.onchange = (e) => {
        const v = e.target.value;
        setVal(tsVal, v.replace("-", "/"));
        debouncedSend("ts", "/ts?v=" + v, 30);
      };

      rnd.onclick = () => sendNow("/rand");

      mute.onchange = (e) => setUiMuted(e.target.checked);
    </script>
  </body>
</html>
